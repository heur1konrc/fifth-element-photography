<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Your Prints - Fifth Element Photography</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px 0;
        }
        
        .wizard-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 300;
        }
        
        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: space-between;
            padding: 30px 50px;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #dee2e6;
            color: #6c757d;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        
        .step.active .step-number {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }
        
        .step.completed .step-number {
            background: #28a745;
            color: white;
        }
        
        .step-label {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .step.active .step-label {
            color: #667eea;
            font-weight: 600;
        }
        
        .step-connector {
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #dee2e6;
            z-index: -1;
        }
        
        .step:last-child .step-connector {
            display: none;
        }
        
        .step.completed .step-connector {
            background: #28a745;
        }
        
        /* Content Area */
        .wizard-content {
            padding: 40px;
            min-height: 400px;
        }
        
        .wizard-step {
            display: none;
        }
        
        .wizard-step.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .step-title {
            font-size: 1.5rem;
            font-weight: 300;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        /* Option Cards */
        .option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .option-card {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .option-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .option-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea15, #764ba215);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .option-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #667eea;
        }
        
        .option-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        
        .option-description {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .option-price {
            font-size: 1.1rem;
            font-weight: bold;
            color: #28a745;
            margin-top: 5px;
        }
        
        /* Navigation Buttons */
        .wizard-navigation {
            display: flex;
            justify-content: space-between;
            padding: 20px 40px;
            background: #f8f9fa;
            border-top: 2px solid #dee2e6;
        }
        
        .btn-wizard {
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-back {
            background: #6c757d;
            color: white;
            border: none;
        }
        
        .btn-back:hover {
            background: #5a6268;
            transform: translateX(-5px);
        }
        
        .btn-next {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
        }
        
        .btn-next:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-next:disabled {
            background: #dee2e6;
            color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Image Preview */
        .image-preview {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .image-info {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .info-badge {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        /* Review Section */
        .review-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .review-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .review-item:last-child {
            border-bottom: none;
        }
        
        .review-label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .review-value {
            color: #6c757d;
        }
        
        .review-total {
            font-size: 1.5rem;
            color: #28a745;
            font-weight: bold;
        }
        
        .btn-add-to-cart {
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            border-radius: 10px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-add-to-cart:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.4);
        }
        
        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Size Selector */
        .size-selector-container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .size-label {
            display: block;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .size-dropdown {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1rem;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.3s;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23667eea' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 45px;
        }
        
        .size-dropdown:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .size-dropdown:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .size-dropdown option {
            padding: 10px;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .wizard-container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .progress-steps {
                padding: 20px 10px;
            }
            
            .step-label {
                font-size: 0.7rem;
            }
            
            .step-number {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
            
            .wizard-content {
                padding: 20px;
            }
            
            .option-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 10px;
            }
            
            .option-card {
                padding: 12px;
                min-height: 70px;
            }
            
            .option-title {
                font-size: 0.95rem;
            }
            
            .option-price {
                font-size: 1rem;
            }
            
            .option-icon {
                font-size: 2rem;
                margin-bottom: 10px;
            }
            
            .wizard-navigation {
                padding: 15px 20px;
            }
            
            .btn-wizard {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
            
            .image-preview img {
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="wizard-container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-print"></i> Order Your Prints</h1>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">Professional quality prints delivered to your door</p>
        </div>
        
        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="step active" id="progress-step-1">
                <div class="step-number">1</div>
                <div class="step-label">Product Type</div>
                <div class="step-connector"></div>
            </div>
            <div class="step" id="progress-step-2">
                <div class="step-number">2</div>
                <div class="step-label">Options</div>
                <div class="step-connector"></div>
            </div>
            <div class="step" id="progress-step-3">
                <div class="step-number">3</div>
                <div class="step-label">Size</div>
                <div class="step-connector"></div>
            </div>
            <div class="step" id="progress-step-4">
                <div class="step-number">4</div>
                <div class="step-label">Review</div>
            </div>
        </div>
        
        <!-- Wizard Content -->
        <div class="wizard-content">
            <!-- Image Preview (shown on all steps) -->
            <div class="image-preview">
                <img id="preview-image" src="" alt="Selected Image">
                <div class="image-info">
                    <span class="info-badge" id="image-dimensions">Loading...</span>
                    <span class="info-badge" id="image-ratio">Ratio: --</span>
                    <span class="info-badge" id="image-dpi">DPI: --</span>
                </div>
            </div>
            
            <!-- Step 1: Product Type -->
            <div class="wizard-step active" id="step-1">
                <h2 class="step-title">Choose Your Product Type</h2>
                <div class="option-grid" id="product-types-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading product types...</p>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Sub-Options -->
            <div class="wizard-step" id="step-2">
                <h2 class="step-title">Choose Your Options</h2>
                <div class="option-grid" id="sub-options-grid">
                    <!-- Dynamically loaded -->
                </div>
            </div>
            
            <!-- Step 3: Size Selection -->
            <div class="wizard-step" id="step-3">
                <h2 class="step-title">Choose Your Size</h2>
                <div class="size-selector-container">
                    <label for="size-select" class="size-label">Select a print size:</label>
                    <select id="size-select" class="size-dropdown">
                        <option value="">-- Select Size --</option>
                    </select>
                </div>
            </div>
            
            <!-- Step 4: Review & Add to Cart -->
            <div class="wizard-step" id="step-4">
                <h2 class="step-title">Review Your Selection</h2>
                <div class="review-section">
                    <div class="review-item">
                        <span class="review-label">Product Type:</span>
                        <span class="review-value" id="review-product-type">--</span>
                    </div>
                    <div class="review-item">
                        <span class="review-label">Options:</span>
                        <span class="review-value" id="review-options">--</span>
                    </div>
                    <div class="review-item">
                        <span class="review-label">Size:</span>
                        <span class="review-value" id="review-size">--</span>
                    </div>
                    <div class="review-item">
                        <span class="review-label">Image:</span>
                        <span class="review-value" id="review-image">--</span>
                    </div>
                    <div class="review-item">
                        <span class="review-label">Price:</span>
                        <span class="review-total" id="review-price">$0.00</span>
                    </div>
                </div>
                <button class="btn-add-to-cart" onclick="addToCart()">
                    <i class="fas fa-shopping-cart"></i> Add to Cart
                </button>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="wizard-navigation">
            <button class="btn-wizard btn-back" id="btn-back" onclick="previousStep()" style="display: none;">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <button class="btn-wizard btn-next" id="btn-next" onclick="nextStep()" disabled>
                Next <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Wizard state
        let currentStep = 1;
        let imageUrl = '';
        let imageData = {};
        let allProducts = [];
        let selection = {
            productType: null,
            productTypeId: null,
            subOption: null,
            categoryId: null,
            size: null,
            productId: null,
            price: 0,
            productName: ''
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Get image URL from query parameter
            const urlParams = new URLSearchParams(window.location.search);
            imageUrl = urlParams.get('image');
            
            if (!imageUrl) {
                alert('No image specified!');
                return;
            }
            
            // Load image preview
            document.getElementById('preview-image').src = imageUrl;
            
            // Load image data and products
            loadImageData();
            loadProducts();
        });
        
        function loadImageData() {
            const img = new Image();
            img.onload = function() {
                imageData = {
                    width: this.width,
                    height: this.height,
                    ratio: (this.width / this.height).toFixed(2),
                    dpi: Math.round((this.width / (this.width / 300)))
                };
                
                document.getElementById('image-dimensions').textContent = `${this.width} × ${this.height} px`;
                document.getElementById('image-ratio').textContent = `Ratio: ${imageData.ratio}:1`;
                document.getElementById('image-dpi').textContent = `DPI: ${imageData.dpi}`;
            };
            img.src = imageUrl;
        }
        
        function loadProducts() {
            fetch('/api/print-order/products')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        allProducts = data.products;
                        loadProductTypes();
                    } else {
                        alert('Error loading products: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to load products');
                });
        }
        
        function loadProductTypes() {
            // Define the desired order
            const desiredOrder = [
                'Canvas Prints',
                'Framed Canvas Prints',
                'Fine Art Paper Prints',
                'Framed Fine Art Paper Prints',
                'Foam-Mounted Fine Art Paper Prints',
                'Metal Prints',
                'Peel and Stick Prints',
                'Rolled Canvas Prints'
            ];
            
            // Get unique product types
            const productTypes = {};
            allProducts.forEach(product => {
                if (!productTypes[product.product_type]) {
                    productTypes[product.product_type] = {
                        name: product.product_type,
                        count: 0,
                        icon: getProductTypeIcon(product.product_type)
                    };
                }
                productTypes[product.product_type].count++;
            });
            
            // Sort by desired order
            const sortedTypes = desiredOrder
                .filter(name => productTypes[name])
                .map(name => productTypes[name]);
            
            // Render product type cards
            const grid = document.getElementById('product-types-grid');
            grid.innerHTML = '';
            
            sortedTypes.forEach(type => {
                const card = document.createElement('div');
                card.className = 'option-card';
                card.onclick = () => selectProductType(type.name);
                card.innerHTML = `
                    <div class="option-icon">${type.icon}</div>
                    <div class="option-title">${type.name}</div>
                    <div class="option-description">${type.count} options</div>
                `;
                grid.appendChild(card);
            });
        }
        
        function getProductTypeIcon(type) {
            const icons = {
                'Canvas': '<i class="fas fa-image"></i>',
                'Framed Canvas': '<i class="fas fa-frame"></i>',
                'Fine Art Paper': '<i class="fas fa-file-image"></i>',
                'Framed Fine Art': '<i class="fas fa-portrait"></i>',
                'Foam Mounted': '<i class="fas fa-layer-group"></i>',
                'Metal': '<i class="fas fa-medal"></i>',
                'Peel & Stick': '<i class="fas fa-sticky-note"></i>'
            };
            return icons[type] || '<i class="fas fa-print"></i>';
        }
        
        function selectProductType(typeName) {
            selection.productType = typeName;
            
            // Highlight selected card
            document.querySelectorAll('#product-types-grid .option-card').forEach(card => {
                card.classList.remove('selected');
                if (card.querySelector('.option-title').textContent === typeName) {
                    card.classList.add('selected');
                }
            });
            
            // Enable next button
            document.getElementById('btn-next').disabled = false;
        }
        
        // Helper functions to parse framed product names
        function parseFramedCanvas(name) {
            // Example: "Framed Canvas Print - 0.75" Frame - Black - 11x14"
            const depthMatch = name.match(/(\d+\.?\d*)" Frame/);
            const colorMatch = name.match(/Frame - (\w+) -/);
            return {
                frameDepth: depthMatch ? depthMatch[1] + '"' : null,
                frameColor: colorMatch ? colorMatch[1] : null
            };
        }
        
        function parseFramedFineArt(name) {
            // Example: "Framed Fine Art Black No Mat Archival Matte 10×10"
            const parts = name.replace('Framed Fine Art ', '').split(' ');
            const frameColor = parts[0]; // First word is color
            
            // Find mat size (contains "Mat")
            let matSize = 'No Mat';
            let matIndex = -1;
            for (let i = 0; i < parts.length; i++) {
                if (parts[i].includes('Mat')) {
                    matIndex = i;
                    if (i > 0 && parts[i-1].match(/^\d/)) {
                        matSize = parts[i-1] + ' ' + parts[i];
                    } else {
                        matSize = parts[i-1] + ' ' + parts[i];
                    }
                    break;
                }
            }
            
            // Paper type is everything after mat size and before size
            let paperType = '';
            if (matIndex > 0) {
                const afterMat = parts.slice(matIndex + 1);
                // Remove the size (last element with x or ×)
                const paperParts = afterMat.filter(p => !p.match(/\d+[x×]\d+/));
                paperType = paperParts.join(' ');
            }
            
            return {
                frameColor: frameColor,
                matSize: matSize,
                paperType: paperType
            };
        }
        
        function loadSubOptions() {
            const grid = document.getElementById('sub-options-grid');
            grid.innerHTML = '';
            
            // Handle framed products differently
            if (selection.productType === 'Framed Canvas Prints') {
                // Extract unique frame depth + color combinations
                const options = new Set();
                allProducts.forEach(product => {
                    if (product.product_type === selection.productType) {
                        const parsed = parseFramedCanvas(product.name);
                        if (parsed.frameDepth && parsed.frameColor) {
                            options.add(`${parsed.frameDepth} - ${parsed.frameColor}`);
                        }
                    }
                });
                
                // Sort and render
                Array.from(options).sort().forEach(option => {
                    const card = document.createElement('div');
                    card.className = 'option-card';
                    card.onclick = () => selectSubOption(option);
                    card.innerHTML = `<div class="option-title">${option}</div>`;
                    grid.appendChild(card);
                });
            } else if (selection.productType === 'Framed Fine Art Paper Prints') {
                // Use cascading dropdowns instead of cards
                grid.innerHTML = `
                    <div style="max-width: 600px; margin: 0 auto;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Paper Type:</label>
                            <select id="paper-type-select" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px;">
                                <option value="">-- Select Paper Type --</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Mat Size:</label>
                            <select id="mat-size-select" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px;" disabled>
                                <option value="">-- Select Mat Size --</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Frame Color:</label>
                            <select id="frame-color-select" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px;" disabled>
                                <option value="">-- Select Frame Color --</option>
                            </select>
                        </div>
                    </div>
                `;
                
                // Extract unique paper types
                const paperTypes = new Set();
                allProducts.forEach(product => {
                    if (product.product_type === selection.productType) {
                        const parsed = parseFramedFineArt(product.name);
                        if (parsed.paperType) paperTypes.add(parsed.paperType);
                    }
                });
                
                // Populate paper type dropdown
                const paperSelect = document.getElementById('paper-type-select');
                Array.from(paperTypes).sort().forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    paperSelect.appendChild(option);
                });
                
                // Handle paper type selection
                paperSelect.addEventListener('change', function() {
                    const matSelect = document.getElementById('mat-size-select');
                    const colorSelect = document.getElementById('frame-color-select');
                    
                    if (this.value) {
                        // Extract mat sizes for selected paper type
                        const matSizes = new Set();
                        allProducts.forEach(product => {
                            if (product.product_type === selection.productType) {
                                const parsed = parseFramedFineArt(product.name);
                                if (parsed.paperType === this.value && parsed.matSize) {
                                    matSizes.add(parsed.matSize);
                                }
                            }
                        });
                        
                        // Populate mat size dropdown
                        matSelect.innerHTML = '<option value="">-- Select Mat Size --</option>';
                        Array.from(matSizes).sort().forEach(size => {
                            const option = document.createElement('option');
                            option.value = size;
                            option.textContent = size;
                            matSelect.appendChild(option);
                        });
                        matSelect.disabled = false;
                        
                        // Reset and disable color select
                        colorSelect.innerHTML = '<option value="">-- Select Frame Color --</option>';
                        colorSelect.disabled = true;
                        document.getElementById('btn-next').disabled = true;
                    } else {
                        matSelect.disabled = true;
                        colorSelect.disabled = true;
                        document.getElementById('btn-next').disabled = true;
                    }
                });
                
                // Handle mat size selection
                document.getElementById('mat-size-select').addEventListener('change', function() {
                    const paperType = document.getElementById('paper-type-select').value;
                    const colorSelect = document.getElementById('frame-color-select');
                    
                    if (this.value) {
                        // Extract colors for selected paper type + mat size
                        const colors = new Set();
                        allProducts.forEach(product => {
                            if (product.product_type === selection.productType) {
                                const parsed = parseFramedFineArt(product.name);
                                if (parsed.paperType === paperType && parsed.matSize === this.value && parsed.frameColor) {
                                    colors.add(parsed.frameColor);
                                }
                            }
                        });
                        
                        // Populate color dropdown
                        colorSelect.innerHTML = '<option value="">-- Select Frame Color --</option>';
                        Array.from(colors).sort().forEach(color => {
                            const option = document.createElement('option');
                            option.value = color;
                            option.textContent = color;
                            colorSelect.appendChild(option);
                        });
                        colorSelect.disabled = false;
                        document.getElementById('btn-next').disabled = true;
                    } else {
                        colorSelect.disabled = true;
                        document.getElementById('btn-next').disabled = true;
                    }
                });
                
                // Handle color selection
                document.getElementById('frame-color-select').addEventListener('change', function() {
                    if (this.value) {
                        const paperType = document.getElementById('paper-type-select').value;
                        const matSize = document.getElementById('mat-size-select').value;
                        const frameColor = this.value;
                        
                        // Store selection as combined string
                        selection.subOption = `${paperType} - ${matSize} - ${frameColor}`;
                        document.getElementById('btn-next').disabled = false;
                    } else {
                        document.getElementById('btn-next').disabled = true;
                    }
                });
            } else {
                // For non-framed products, use categories as before
                const categories = {};
                allProducts.forEach(product => {
                    if (product.product_type === selection.productType) {
                        if (!categories[product.category]) {
                            categories[product.category] = {
                                name: product.category,
                                count: 0
                            };
                        }
                        categories[product.category].count++;
                    }
                });
                
                Object.values(categories).forEach(category => {
                    const card = document.createElement('div');
                    card.className = 'option-card';
                    card.onclick = () => selectSubOption(category.name);
                    card.innerHTML = `
                        <div class="option-title">${category.name}</div>
                        <div class="option-description">${category.count} sizes</div>
                    `;
                    grid.appendChild(card);
                });
            }
        }
        
        function selectSubOption(categoryName) {
            selection.subOption = categoryName;
            
            // Highlight selected card
            document.querySelectorAll('#sub-options-grid .option-card').forEach(card => {
                card.classList.remove('selected');
                if (card.querySelector('.option-title').textContent === categoryName) {
                    card.classList.add('selected');
                }
            });
            
            // Enable next button
            document.getElementById('btn-next').disabled = false;
        }
        
        function loadSizes() {
            // Get products matching selection
            let matchingProducts;
            
            if (selection.productType === 'Framed Canvas Prints') {
                // Match by frame depth and color from parsed name
                matchingProducts = allProducts.filter(product => {
                    if (product.product_type !== selection.productType) return false;
                    const parsed = parseFramedCanvas(product.name);
                    const optionKey = `${parsed.frameDepth} - ${parsed.frameColor}`;
                    return optionKey === selection.subOption;
                });
            } else if (selection.productType === 'Framed Fine Art Paper Prints') {
                // Match by paper type, mat size, and color from parsed name
                matchingProducts = allProducts.filter(product => {
                    if (product.product_type !== selection.productType) return false;
                    const parsed = parseFramedFineArt(product.name);
                    const optionKey = `${parsed.paperType} - ${parsed.matSize} - ${parsed.frameColor}`;
                    return optionKey === selection.subOption;
                });
            } else {
                // For non-framed products, match by category
                matchingProducts = allProducts.filter(product => 
                    product.product_type === selection.productType &&
                    product.category === selection.subOption
                );
            }
            
            // Sort by price
            matchingProducts.sort((a, b) => a.retail_price - b.retail_price);
            
            // Populate dropdown
            const dropdown = document.getElementById('size-select');
            dropdown.innerHTML = '<option value="">-- Select Size --</option>';
            
            matchingProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.size} - $${product.retail_price.toFixed(2)}`;
                option.dataset.product = JSON.stringify(product);
                dropdown.appendChild(option);
            });
            
            // Add change listener
            dropdown.onchange = function() {
                if (this.value) {
                    const product = JSON.parse(this.options[this.selectedIndex].dataset.product);
                    selectSize(product);
                } else {
                    document.getElementById('btn-next').disabled = true;
                }
            };
        }
        
        function selectSize(product) {
            selection.size = product.size;
            selection.productId = product.id;
            selection.price = product.retail_price;
            selection.productName = product.name;
            
            // Enable next button
            document.getElementById('btn-next').disabled = false;
        }
        
        function loadReview() {
            document.getElementById('review-product-type').textContent = selection.productType;
            document.getElementById('review-options').textContent = selection.subOption;
            document.getElementById('review-size').textContent = selection.size;
            document.getElementById('review-image').textContent = imageUrl.split('/').pop();
            document.getElementById('review-price').textContent = `$${selection.price.toFixed(2)}`;
        }
        
        function nextStep() {
            if (currentStep < 4) {
                currentStep++;
                updateWizard();
                
                // Load data for new step
                if (currentStep === 2) {
                    loadSubOptions();
                } else if (currentStep === 3) {
                    loadSizes();
                } else if (currentStep === 4) {
                    loadReview();
                }
            }
        }
        
        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateWizard();
            }
        }
        
        function updateWizard() {
            // Update progress steps
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`progress-step-${i}`);
                step.classList.remove('active', 'completed');
                
                if (i < currentStep) {
                    step.classList.add('completed');
                } else if (i === currentStep) {
                    step.classList.add('active');
                }
            }
            
            // Update wizard steps
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step-${i}`);
                step.classList.remove('active');
                
                if (i === currentStep) {
                    step.classList.add('active');
                }
            }
            
            // Update navigation buttons
            document.getElementById('btn-back').style.display = currentStep > 1 ? 'block' : 'none';
            document.getElementById('btn-next').style.display = currentStep < 4 ? 'block' : 'none';
            document.getElementById('btn-next').disabled = true;
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function addToCart() {
            // TODO: Implement cart functionality
            alert(`Added to cart:\n${selection.productName}\nSize: ${selection.size}\nPrice: $${selection.price.toFixed(2)}`);
            
            // Reset wizard
            currentStep = 1;
            selection = {
                productType: null,
                subOption: null,
                size: null,
                productId: null,
                price: 0,
                productName: ''
            };
            updateWizard();
            loadProductTypes();
        }
    </script>
</body>
</html>


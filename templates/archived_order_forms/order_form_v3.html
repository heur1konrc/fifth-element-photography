<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Print - Fifth Element Photography</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px 0;
        }
        
        .order-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 300;
        }
        
        .content {
            padding: 30px;
        }
        
        .image-preview {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .image-info {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .image-info .badge {
            margin: 5px;
            padding: 8px 12px;
            font-size: 13px;
        }
        
        .product-section {
            margin-bottom: 30px;
        }
        
        .product-section h4 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }
        
        .product-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .product-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.15);
            transform: translateY(-2px);
        }
        
        .product-card.selected {
            border-color: #007bff;
            background: #e3f2fd;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.25);
        }
        
        .product-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .product-price {
            color: #007bff;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .size-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .size-option {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .size-option:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
        }
        
        .size-option.selected {
            border-color: #007bff;
            background: #e3f2fd;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.25);
        }
        
        .size-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .size-price {
            color: #007bff;
            font-weight: 700;
            margin-top: 5px;
        }
        
        .cart-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            position: sticky;
            top: 20px;
        }
        
        .cart-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
        }
        
        .cart-total {
            background: #007bff;
            color: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 600;
            margin-top: 20px;
        }
        
        .btn-add-to-cart {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 8px;
            width: 100%;
            margin-top: 15px;
            transition: all 0.3s ease;
        }
        
        .btn-add-to-cart:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .btn-checkout {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 8px;
            width: 100%;
            margin-top: 15px;
            transition: all 0.3s ease;
        }
        
        .btn-checkout:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .content {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .size-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .cart-summary {
                position: static;
                margin-top: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="order-container">
        <div class="header">
            <h1><i class="fas fa-camera"></i> Order Your Prints NOW</h1>
            <p class="mb-0">Professional quality prints delivered to your door</p>
        </div>
        
        <div class="content">
            <div class="row">
                <!-- Left Column: Image & Products -->
                <div class="col-lg-8">
                    <!-- Image Preview -->
                    <div class="image-preview">
                        <img id="selected-image" src="" alt="Selected Image">
                        <div class="image-info">
                            <span class="badge bg-secondary"><i class="fas fa-ruler-combined"></i> <span id="image-dimensions">Loading...</span></span>
                            <span class="badge bg-secondary"><i class="fas fa-expand-arrows-alt"></i> <span id="image-ratio">Loading...</span></span>
                            <span class="badge bg-secondary"><i class="fas fa-print"></i> <span id="image-dpi">Loading...</span></span>
                        </div>
                    </div>
                    
                    <!-- Product Selection -->
                    <div id="product-container" class="loading">
                        <div class="spinner"></div>
                        <p>Loading available products...</p>
                    </div>
                </div>
                
                <!-- Right Column: Cart -->
                <div class="col-lg-4">
                    <div class="cart-summary">
                        <h4><i class="fas fa-shopping-cart"></i> Your Cart</h4>
                        <div id="cart-items">
                            <div class="text-muted text-center py-4">
                                <i class="fas fa-cart-plus fa-3x mb-3"></i>
                                <p>Your cart is empty</p>
                            </div>
                        </div>
                        <div id="cart-total-section" style="display: none;">
                            <div class="cart-total">
                                Total: $<span id="cart-total">0.00</span>
                            </div>
                            <button class="btn btn-checkout" onclick="proceedToCheckout()">
                                <i class="fas fa-credit-card"></i> Proceed to Checkout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Order Form V3 - Clean implementation
        const orderForm = {
            imageUrl: null,
            imageData: null,
            products: [],
            cart: [],
            selectedProduct: null,
            selectedSize: null,
            
            init() {
                // Get image URL from query parameter
                const urlParams = new URLSearchParams(window.location.search);
                this.imageUrl = urlParams.get('image');
                
                if (!this.imageUrl) {
                    alert('No image selected. Please select an image from the gallery.');
                    return;
                }
                
                // Load image and get metadata
                this.loadImage();
            },
            
            loadImage() {
                const img = document.getElementById('selected-image');
                img.src = this.imageUrl;
                
                img.onload = () => {
                    // Get image dimensions
                    const width = img.naturalWidth;
                    const height = img.naturalHeight;
                    const ratio = (width / height).toFixed(2);
                    
                    // Display image info
                    document.getElementById('image-dimensions').textContent = `${width} × ${height} px`;
                    document.getElementById('image-ratio').textContent = `${ratio}:1`;
                    document.getElementById('image-dpi').textContent = 'Calculating...';
                    
                    // Store image data
                    this.imageData = {
                        url: this.imageUrl,
                        width: width,
                        height: height,
                        ratio: ratio
                    };
                    
                    // Load compatible products
                    this.loadProducts();
                };
                
                img.onerror = () => {
                    alert('Failed to load image. Please try again.');
                };
            },
            
            async loadProducts() {
                try {
                    const response = await fetch('/api/order/products', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(this.imageData)
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.products = data.products;
                        this.renderProducts();
                    } else {
                        document.getElementById('product-container').innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> ${data.error}
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading products:', error);
                    document.getElementById('product-container').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> Failed to load products. Please refresh the page.
                        </div>
                    `;
                }
            },
            
            renderProducts() {
                const container = document.getElementById('product-container');
                
                if (this.products.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No compatible products found for this image size.
                        </div>
                    `;
                    return;
                }
                
                // Group products by type
                const grouped = {};
                this.products.forEach(product => {
                    if (!grouped[product.product_type]) {
                        grouped[product.product_type] = [];
                    }
                    grouped[product.product_type].push(product);
                });
                
                let html = '';
                for (const [type, items] of Object.entries(grouped)) {
                    html += `
                        <div class="product-section">
                            <h4>${type}</h4>
                            ${this.renderProductGroup(items)}
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            },
            
            renderProductGroup(products) {
                // Group by category
                const byCategory = {};
                products.forEach(p => {
                    if (!byCategory[p.category]) {
                        byCategory[p.category] = [];
                    }
                    byCategory[p.category].push(p);
                });
                
                let html = '';
                for (const [category, items] of Object.entries(byCategory)) {
                    html += `
                        <div class="product-card" onclick="orderForm.selectCategory('${category}')">
                            <div class="product-name">${category}</div>
                            <div class="size-grid">
                                ${items.map(item => `
                                    <div class="size-option" onclick="event.stopPropagation(); orderForm.selectProduct(${item.id})">
                                        <div class="size-label">${item.size}"</div>
                                        <div class="size-price">$${item.retail_price.toFixed(2)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                return html;
            },
            
            selectProduct(productId) {
                const product = this.products.find(p => p.id === productId);
                if (!product) return;
                
                this.selectedProduct = product;
                
                // Highlight selected
                document.querySelectorAll('.size-option').forEach(el => el.classList.remove('selected'));
                event.target.closest('.size-option').classList.add('selected');
                
                // Show add to cart button if not already in view
                this.showAddToCartButton(product);
            },
            
            showAddToCartButton(product) {
                const card = event.target.closest('.product-card');
                let btn = card.querySelector('.btn-add-to-cart');
                
                if (!btn) {
                    btn = document.createElement('button');
                    btn.className = 'btn-add-to-cart';
                    btn.innerHTML = '<i class="fas fa-cart-plus"></i> Add to Cart';
                    btn.onclick = () => this.addToCart(product);
                    card.appendChild(btn);
                }
            },
            
            addToCart(product) {
                this.cart.push({
                    product: product,
                    image: this.imageUrl,
                    quantity: 1
                });
                
                this.renderCart();
                
                // Show success message
                alert(`Added ${product.name} to cart!`);
            },
            
            renderCart() {
                const container = document.getElementById('cart-items');
                const totalSection = document.getElementById('cart-total-section');
                
                if (this.cart.length === 0) {
                    container.innerHTML = `
                        <div class="text-muted text-center py-4">
                            <i class="fas fa-cart-plus fa-3x mb-3"></i>
                            <p>Your cart is empty</p>
                        </div>
                    `;
                    totalSection.style.display = 'none';
                    return;
                }
                
                let html = '';
                let total = 0;
                
                this.cart.forEach((item, index) => {
                    const price = item.product.retail_price * item.quantity;
                    total += price;
                    
                    html += `
                        <div class="cart-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${item.product.name}</strong><br>
                                    <small class="text-muted">${item.product.size}"</small>
                                </div>
                                <button class="btn btn-sm btn-danger" onclick="orderForm.removeFromCart(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="mt-2">
                                <strong>$${price.toFixed(2)}</strong>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                document.getElementById('cart-total').textContent = total.toFixed(2);
                totalSection.style.display = 'block';
            },
            
            removeFromCart(index) {
                this.cart.splice(index, 1);
                this.renderCart();
            }
        };
        
        function proceedToCheckout() {
            if (orderForm.cart.length === 0) {
                alert('Your cart is empty!');
                return;
            }
            
            // Send cart to checkout
            const cartData = {
                items: orderForm.cart,
                image: orderForm.imageUrl
            };
            
            // For now, just show alert - will integrate with payment later
            console.log('Checkout data:', cartData);
            alert('Checkout functionality will be integrated next. Cart data logged to console.');
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            orderForm.init();
        });
    </script>
</body>
</html>

